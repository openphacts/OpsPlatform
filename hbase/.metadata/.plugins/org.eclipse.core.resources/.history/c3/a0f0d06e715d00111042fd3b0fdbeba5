import java.util.ArrayList;
import java.util.Iterator;
import java.io.IOException;

import org.apache.hadoop.hbase.HBaseConfiguration;
import org.apache.hadoop.hbase.HColumnDescriptor;
import org.apache.hadoop.hbase.HTableDescriptor;
import org.apache.hadoop.hbase.client.Get;
import org.apache.hadoop.hbase.client.HBaseAdmin;
import org.apache.hadoop.hbase.client.HTable;
import org.apache.hadoop.hbase.client.Put;
import org.apache.hadoop.hbase.client.Result;
import org.apache.hadoop.hbase.client.ResultScanner;
import org.apache.hadoop.hbase.client.Scan;
import org.apache.hadoop.hbase.util.Bytes;
import org.apache.hadoop.conf.Configuration;


public class HBaseUtil {	
	public static void cachePredicates(ArrayList<String> preds)  throws IOException {
		HBaseConfiguration conf = new HBaseConfiguration();
	    conf.set("hbase.master","localhost:60000");
	    HBaseAdmin hbase = new HBaseAdmin(conf);
	    
	    HTableDescriptor desc;
	    if (hbase.tableExists("predicates") == false) {
	    	desc = new HTableDescriptor("predicates");
	    }
	    else {
		     desc = hbase.getTableDescriptor("predicates".getBytes());
	    }
	    
	    for (Iterator iter = preds.iterator(); iter.hasNext();) {
	    	String pred = ((String)iter.next()).replaceAll("[^A-Za-z0-9 ]", "");
	    	if (desc.hasFamily(pred.getBytes()) == false) {
	    		HColumnDescriptor c = new HColumnDescriptor(pred.getBytes());
	    		desc.addFamily(c);
	    	}
	    }

	    if (hbase.tableExists("predicates") == false) {
	    	hbase.createTable(desc);
	    }
	    hbase.disableTable("predicates");
	}
	
	public static void createTableStruct(String table, ArrayList<String> columns)  throws IOException {
		HBaseConfiguration conf = new HBaseConfiguration();
	    conf.set("hbase.master","localhost:60000");
	    HBaseAdmin hbase = new HBaseAdmin(conf);
	    
	    HTableDescriptor desc;
	    if (hbase.tableExists(table) == false) {
	    	desc = new HTableDescriptor(table);
	    	HColumnDescriptor literal = new HColumnDescriptor("literal".getBytes());
	    	desc.addFamily(literal);
	    }
	    else {
		     desc = hbase.getTableDescriptor(table.getBytes());
	    }
	    
		for (Iterator iter = columns.iterator(); iter.hasNext();) {
			String columnName = ((String)iter.next()).replaceAll("[^A-Za-z0-9 ]", "");
//			System.out.println("COLUMN: " + columnName);
			
			HColumnDescriptor c = new HColumnDescriptor(columnName.getBytes());
			if (desc.hasFamily(columnName.getBytes()) == false) {
				desc.addFamily(c);
			}
		}

	    if (hbase.tableExists(table) == false) {
	    	hbase.createTable(desc);
	    }
	}
	
	public static void addRow(String tableName, String key, String columnFam, String columnName, String val) throws IOException {
		HBaseConfiguration conf = new HBaseConfiguration();
	    conf.set("hbase.master","localhost:60000");
	    
	    // add triples to HBase
	    HTable table = new HTable(conf, tableName);
	    Put row = new Put(Bytes.toBytes(key));
	    row.add(Bytes.toBytes(columnFam.replaceAll("[^A-Za-z0-9 ]", "")), Bytes.toBytes(columnName.replaceAll("[^A-Za-z0-9 ]", "")), Bytes.toBytes(val));
	    table.put(row);
	    
	    // store full predicate URI
	    String pred;
	    if (columnFam != "literal") {
	    	pred = columnFam;
	    }
	    else {
	    	pred = columnName;
	    }
	    
	    table = new HTable(conf, "predicates");
	    row = new Put(Bytes.toBytes(pred.replaceAll("[^A-Za-z0-9 ]", ""))); 
	    row.add(Bytes.toBytes(pred.replaceAll("[^A-Za-z0-9 ]", "")), Bytes.toBytes(""), Bytes.toBytes(pred));
	    table.put(row);
	}
}
